import React, { useState, useEffect, useCallback } from 'react';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

const commonWords = ['el', 'la', 'de', 'que', 'y', 'a', 'en', 'un', 'ser', 'se', 'no', 'haber', 'por', 'con', 'su', 'para', 'como', 'estar', 'tener', 'le'];

const SpeechAssistApp = () => {
  const [currentWord, setCurrentWord] = useState('');
  const [currentPhrase, setCurrentPhrase] = useState('');
  const [suggestions, setSuggestions] = useState([]);
  const [audioContext, setAudioContext] = useState(null);
  const [isAlarmPlaying, setIsAlarmPlaying] = useState(false);

  useEffect(() => {
    setAudioContext(new (window.AudioContext || window.webkitAudioContext)());
  }, []);

  useEffect(() => {
    if (currentWord.length > 1) {
      const newSuggestions = commonWords.filter(word => word.startsWith(currentWord.toLowerCase()));
      setSuggestions(newSuggestions.slice(0, 3));
    } else {
      setSuggestions([]);
    }
  }, [currentWord]);

  const handleLetterClick = (letter) => {
    setCurrentWord(prev => prev + letter);
  };

  const handleSpaceClick = () => {
    setCurrentPhrase(prev => prev + (prev ? ' ' : '') + currentWord);
    setCurrentWord('');
  };

  const handleDeleteLetter = () => {
    setCurrentWord(prev => prev.slice(0, -1));
  };

  const handleDeleteWord = () => {
    setCurrentWord('');
  };

  const handleDeletePhrase = () => {
    setCurrentPhrase('');
    setCurrentWord('');
  };

  const handleReadPhrase = () => {
    if ('speechSynthesis' in window) {
      const utterance = new SpeechSynthesisUtterance(currentPhrase);
      utterance.lang = 'es-ES';
      window.speechSynthesis.speak(utterance);
    } else {
      alert('La síntesis de voz no está soportada en este navegador.');
    }
    handleDeletePhrase();
  };

  const playAlarm = useCallback(() => {
    if (audioContext && !isAlarmPlaying) {
      setIsAlarmPlaying(true);
      
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();

      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);

      oscillator.type = 'sawtooth';
      oscillator.frequency.setValueAtTime(440, audioContext.currentTime);

      gainNode.gain.setValueAtTime(1, audioContext.currentTime);

      oscillator.start();

      let isHigh = true;
      const intervalId = setInterval(() => {
        oscillator.frequency.setValueAtTime(isHigh ? 880 : 440, audioContext.currentTime);
        isHigh = !isHigh;
      }, 100);

      setTimeout(() => {
        clearInterval(intervalId);
        oscillator.stop();
        setIsAlarmPlaying(false);
      }, 5000);
    }
  }, [audioContext, isAlarmPlaying]);

  const keyboard = [
    ['Q', 'W', 'E', 'R', 'T', 'Y', 'U', 'I', 'O', 'P'],
    ['A', 'S', 'D', 'F', 'G', 'H', 'J', 'K', 'L', 'Ñ'],
    ['Z', 'X', 'C', 'V', 'B', 'N', 'M']
  ];

  return (
    <Card className="w-full max-w-3xl mx-auto bg-white">
      <CardHeader className="bg-green-600 text-white">
        <CardTitle className="text-2xl font-bold">AntonELApp</CardTitle>
      </CardHeader>
      <CardContent className="p-4">
        <div className="bg-gray-100 p-4 mb-4 rounded-md shadow">
          <p className="font-semibold text-green-700">Palabra actual: <span className="font-normal">{currentWord}</span></p>
          <p className="font-semibold text-green-700">Frase actual: <span className="font-normal">{currentPhrase}</span></p>
        </div>
        {keyboard.map((row, rowIndex) => (
          <div key={rowIndex} className="flex justify-center mb-2">
            {row.map((letter) => (
              <Button
                key={letter}
                onClick={() => handleLetterClick(letter)}
                className="mx-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded"
              >
                {letter}
              </Button>
            ))}
          </div>
        ))}
        <Button
          onClick={handleSpaceClick}
          className="w-full my-2 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded"
        >
          Espacio
        </Button>
        <div className="grid grid-cols-2 gap-2 mt-4">
          <Button onClick={handleDeleteLetter} className="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">Borrar Letra</Button>
          <Button onClick={handleDeleteWord} className="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">Borrar Palabra</Button>
          <Button onClick={handleDeletePhrase} className="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">Borrar Frase</Button>
          <Button onClick={handleReadPhrase} className="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">Leer Frase</Button>
        </div>
        <Button
          onClick={playAlarm}
          disabled={isAlarmPlaying}
          className={`w-full mt-4 ${isAlarmPlaying ? 'bg-red-400' : 'bg-red-600 hover:bg-red-700'} text-white font-bold py-3 px-4 rounded text-xl`}
        >
          {isAlarmPlaying ? 'ALARMA SONANDO' : 'AVISO'}
        </Button>
      </CardContent>
    </Card>
  );
};

export default SpeechAssistApp;